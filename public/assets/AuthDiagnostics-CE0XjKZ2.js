import{r,j as e}from"./index-8LC8IQKY.js";import{c as le,s as m}from"./App-oj_FpO4B.js";import{u as ce}from"./index-DcGTfjVj.js";function de(n){try{if(!n)return null;const j=n.split(".");if(j.length<2)return null;const o=j[1].replace(/-/g,"+").replace(/_/g,"/"),R=o.padEnd(o.length+(4-o.length%4)%4,"="),g=atob(R);return JSON.parse(g)}catch{return null}}const ge=()=>{const{state:n}=le(),j=ce(),[o,R]=r.useState(null),[g,Z]=r.useState(null),[x,U]=r.useState(null),[h,T]=r.useState(null),[ee,v]=r.useState(!0),[L,P]=r.useState(null),[M,se]=r.useState(null),[O,A]=r.useState(!1),[I,p]=r.useState(null),[J,$]=r.useState(!1),[q,y]=r.useState(null),[N,F]=r.useState(!1),[S,k]=r.useState(null),[C,V]=r.useState(!1),[_,w]=r.useState(null),[d,W]=r.useState(null),[B,z]=r.useState(null),[K,Y]=r.useState(!1),[G,D]=r.useState(null),te=async(s,t)=>await Promise.race([s,new Promise((i,a)=>setTimeout(()=>a(new Error("timeout")),t))]),c=async()=>{v(!0);try{const{data:{session:s},error:t}=await m.auth.getSession();t&&se(t.message);const i=s?.access_token||null;R(i),Z(de(i));try{const a={};i&&(a.Authorization=`Bearer ${i}`);const l=await fetch("/api/supabase-auth/verify",{headers:a}),u=await l.json().catch(()=>({}));U({ok:l.ok,status:l.status,body:u})}catch(a){U({ok:!1,status:0,error:a?.message||"Network error"})}if(P(null),s?.user?.id)try{const a=await te(m.from("users").select("id,email,first_name,last_name,role,created_at").eq("id",s.user.id).maybeSingle(),4e3);a?.error&&P(a.error.message||"Profile query error"),T(a?.data||null)}catch(a){P(a?.message==="timeout"?"Profile query timed out":a?.message||"Network error"),T(null)}else T(null);try{const l=await(await fetch("/api/config/check")).json();W(l),z(null)}catch(a){z(a?.message||"Failed to fetch server config"),W(null)}}finally{v(!1)}};r.useEffect(()=>{let s=!1;const t=setTimeout(()=>{s||v(!1)},2500);return c().catch(()=>v(!1)),()=>{s=!0,clearTimeout(t)}},[]);const ae=async s=>{try{await navigator.clipboard.writeText(s)}catch{}},E=g?.exp?new Date(g.exp*1e3):null,re=new Date,H=E?Math.max(0,Math.floor((E.getTime()-re.getTime())/1e3)):null,ie=async()=>{Y(!0),D(null);try{const s=await fetch("/api/supabase-auth/demo/session",{method:"POST",headers:{"Content-Type":"application/json"}}),t=await s.json();if(!s.ok){D(t?.error||"Failed to create session");return}localStorage.setItem("sb-emfrwckxctyarphjvfeu-auth-token",JSON.stringify({access_token:t.session.access_token,refresh_token:"dev-refresh-token",expires_in:3600,token_type:"bearer",user:t.session.user})),D("Demo session created! You can now create patients with proper user association."),await c()}catch(s){D(s?.message||"Session creation failed")}finally{Y(!1)}},ne=async()=>{p(null),A(!0);try{const{data:s}=await m.auth.getUser(),t=n.user?.email||s?.user?.email||"user@example.com",i=n.user?.role||"oncologist",a=n.user?.firstName||s?.user?.user_metadata?.first_name||t.split("@")[0],l=n.user?.lastName||s?.user?.user_metadata?.last_name||"User";if(s?.user?.id){const{error:u}=await m.from("users").upsert({id:s.user.id,email:t,first_name:a,last_name:l,role:i,created_at:new Date().toISOString()},{onConflict:"id"});if(u){p(`Failed to create profile: ${u.message}`);return}p("Demo profile created/updated successfully."),await c()}else{const u=crypto.randomUUID(),f=await fetch("/api/supabase-auth/demo/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u,email:t,role:i,first_name:a,last_name:l})}),b=await f.json().catch(()=>({}));if(!f.ok){p(b?.error||"Server demo profile creation failed");return}p("Demo profile created on server."),await c()}}catch(s){p(s?.message||"Unexpected error while creating profile")}finally{A(!1)}},oe=async()=>{if(h?.id&&confirm("Delete this demo profile row?")){y(null),$(!0);try{const{data:s}=await m.auth.getUser();if(s?.user?.id===h.id){const{error:t}=await m.from("users").delete().eq("id",h.id);t?y(`Failed to delete: ${t.message}`):(y("Profile row deleted."),await c())}else{const t=await fetch(`/api/supabase-auth/demo/profile/${encodeURIComponent(h.id)}`,{method:"DELETE"}),i=await t.json().catch(()=>({}));t.ok?(y("Profile row deleted on server."),await c()):y(i?.error||"Server deletion failed")}}catch(s){y(s?.message||"Unexpected error while deleting profile")}finally{$(!1)}}},Q=async()=>{k(null),F(!0);try{const{data:s}=await m.auth.getUser(),t=s?.user?.id||h?.id||"dev-demo-user",i=n.user?.email||s?.user?.email||"demo@oncosaferx.local",a=n.user?.role||"oncologist",f=await fetch("/api/supabase-auth/demo/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,email:i,role:a,first_name:"Demo",last_name:"Clinician",updateAuth:!!s?.user?.id})}),b=await f.json().catch(()=>({}));f.ok?(k("Reset to demo user successful."),await c()):k(b?.error||"Reset failed")}catch(s){k(s?.message||"Unexpected error during reset")}finally{F(!1)}},X=async()=>{w(null),V(!0);try{const{data:s,error:t}=await m.auth.getUser();if(t||!s?.user){w("Supabase session required to sync from auth.");return}const i=s.user,a=i.email||"",l=i.user_metadata?.role||"oncologist",u=i.user_metadata?.first_name||"Demo",f=i.user_metadata?.last_name||"Clinician",{error:b}=await m.from("users").upsert({id:i.id,email:a,role:l,first_name:u,last_name:f,created_at:new Date().toISOString()},{onConflict:"id"});b?w(`Sync failed: ${b.message}`):(w("Synced auth metadata to profile."),await c())}catch(s){w(s?.message||"Unexpected error during sync")}finally{V(!1)}};return e.jsxs("div",{className:"max-w-5xl mx-auto p-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Auth Diagnostics"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"View current session, verify with backend, and confirm profile row. Dev auth is supported."}),e.jsxs("div",{className:"mb-6 flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j(`/auth?next=${encodeURIComponent("/auth-diagnostics")}`),className:"px-3 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Sign in via Supabase"}),e.jsx("button",{onClick:()=>c(),className:"px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200",children:"Refresh Session"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsxs("div",{className:"mb-3 text-xs text-gray-600",children:["App auth: ",n.isAuthenticated?"Authenticated":"Not authenticated"," • User: ",n.user?.email||"n/a"," • Role: ",n.user?.role||"n/a",!o&&e.jsx("div",{className:"mt-1 text-yellow-700",children:"No Supabase session detected (using app-level auth). This is normal in development bypass."})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Session"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:c,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded",children:"Refresh"}),o&&e.jsx("button",{onClick:()=>ae(o),className:"px-3 py-1.5 text-sm bg-gray-100 border rounded",children:"Copy Token"})]})]}),ee?e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"}):o?e.jsxs("div",{className:"text-sm",children:[M&&e.jsxs("div",{className:"mb-2 text-xs text-yellow-700",children:["Session warning: ",M]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Subject (sub)"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:g?.sub||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium text-gray-900",children:g?.email||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Expires"}),e.jsxs("div",{className:"font-medium text-gray-900",children:[E?.toISOString()||"—"," ",H!==null&&`(in ${H}s)`]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Issuer"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:g?.iss||"—"})]})]})]}):e.jsx("div",{className:"text-sm text-red-700",children:"No active session"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Backend Verification"}),x?e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"mb-1",children:["Status: ",e.jsx("span",{className:x.ok?"text-green-700":"text-red-700",children:x.ok?"OK":"Failed"})," (",x.status,")"]}),x.body&&e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(x.body,null,2)}),x.error&&e.jsx("div",{className:"text-red-700",children:x.error})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Waiting…"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Profile Row (public.users)"}),L&&e.jsx("div",{className:"mb-2 text-sm text-yellow-700",children:L}),h?e.jsxs(e.Fragment,{children:[e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(h,null,2)}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:X,disabled:C,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",children:C?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:Q,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:oe,disabled:J,className:"px-3 py-1.5 text-sm bg-red-600 text-white rounded disabled:opacity-50",children:J?"Deleting…":"Delete Demo Profile Row"}),(_||S||q)&&e.jsx("div",{className:"text-xs text-gray-600",children:_||S||q})]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-yellow-700 mb-3",children:"No profile row found for current user."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:X,disabled:C||!o,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",title:o?"":"Requires Supabase session",children:C?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:Q,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:ne,disabled:O,className:"px-3 py-1.5 text-sm bg-green-600 text-white rounded disabled:opacity-50",children:O?"Creating…":"Create Demo Profile Row"}),e.jsx("button",{onClick:ie,disabled:K,className:"px-3 py-1.5 text-sm bg-purple-600 text-white rounded disabled:opacity-50",children:K?"Creating…":"Create Auth Session"}),(_||S||I||G)&&e.jsx("div",{className:"text-xs text-gray-600",children:_||S||I||G})]}),!o&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Tip: No Supabase session detected. The server demo endpoint will be used to insert a profile row (dev-only)."})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Server Config Check"}),B&&e.jsx("div",{className:"text-sm text-red-700",children:B}),d?e.jsxs("div",{className:"text-sm text-gray-700 grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Supabase"}),e.jsxs("div",{children:["Enabled: ",String(d.supabase?.enabled)]}),e.jsxs("div",{children:["URL present: ",String(d.supabase?.urlPresent)]}),e.jsxs("div",{children:["Service role present: ",String(d.supabase?.serviceRolePresent)]}),e.jsxs("div",{children:["JWT secret present: ",String(d.supabase?.jwtSecretPresent)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Deploy Integrations"}),e.jsxs("div",{children:["Netlify configured: ",String(d.netlify?.configured)]}),e.jsxs("div",{children:["Render configured: ",String(d.render?.configured)]})]}),d.warnings?.length>0&&e.jsxs("div",{className:"md:col-span-2 text-xs text-yellow-700",children:["Warnings: ",d.warnings.join(", ")]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"})]})]})]})};export{ge as default};
