import{a8 as Y,r as i,j as e,z as d}from"./index-Bhw970Mt.js";function Z(o){try{if(!o)return null;const n=o.split(".");if(n.length<2)return null;const b=n[1].replace(/-/g,"+").replace(/_/g,"/"),x=b.padEnd(b.length+(4-b.length%4)%4,"="),D=atob(x);return JSON.parse(D)}catch{return null}}const se=()=>{const{state:o}=Y(),[n,b]=i.useState(null),[x,D]=i.useState(null),[u,P]=i.useState(null),[f,R]=i.useState(null),[B,j]=i.useState(!0),[E,C]=i.useState(null),[U,K]=i.useState(null),[L,M]=i.useState(!1),[A,g]=i.useState(null),[O,$]=i.useState(!1),[q,p]=i.useState(null),[N,I]=i.useState(!1),[v,S]=i.useState(null),[k,J]=i.useState(!1),[_,w]=i.useState(null),W=async(s,t)=>await Promise.race([s,new Promise((r,a)=>setTimeout(()=>a(new Error("timeout")),t))]),m=async()=>{j(!0);try{const{data:{session:s},error:t}=await d.auth.getSession();t&&K(t.message);const r=s?.access_token||null;b(r),D(Z(r));try{const a={};r&&(a.Authorization=`Bearer ${r}`);const l=await fetch("/api/supabase-auth/verify",{headers:a}),c=await l.json().catch(()=>({}));P({ok:l.ok,status:l.status,body:c})}catch(a){P({ok:!1,status:0,error:a?.message||"Network error"})}if(C(null),s?.user?.id)try{const a=await W(d.from("users").select("id,email,first_name,last_name,role,created_at").eq("id",s.user.id).maybeSingle(),4e3);a?.error&&C(a.error.message||"Profile query error"),R(a?.data||null)}catch(a){C(a?.message==="timeout"?"Profile query timed out":a?.message||"Network error"),R(null)}else R(null)}finally{j(!1)}};i.useEffect(()=>{let s=!1;const t=setTimeout(()=>{s||j(!1)},2500);return m().catch(()=>j(!1)),()=>{s=!0,clearTimeout(t)}},[]);const G=async s=>{try{await navigator.clipboard.writeText(s)}catch{}},T=x?.exp?new Date(x.exp*1e3):null,H=new Date,F=T?Math.max(0,Math.floor((T.getTime()-H.getTime())/1e3)):null,Q=async()=>{g(null),M(!0);try{const{data:s}=await d.auth.getUser(),t=o.user?.email||s?.user?.email||"user@example.com",r=o.user?.role||"oncologist",a=o.user?.firstName||s?.user?.user_metadata?.first_name||t.split("@")[0],l=o.user?.lastName||s?.user?.user_metadata?.last_name||"User";if(s?.user?.id){const{error:c}=await d.from("users").upsert({id:s.user.id,email:t,first_name:a,last_name:l,role:r,created_at:new Date().toISOString()},{onConflict:"id"});if(c){g(`Failed to create profile: ${c.message}`);return}g("Demo profile created/updated successfully."),await m()}else{const c=`dev-${Date.now()}`,h=await fetch("/api/supabase-auth/demo/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c,email:t,role:r,first_name:a,last_name:l})}),y=await h.json().catch(()=>({}));if(!h.ok){g(y?.error||"Server demo profile creation failed");return}g("Demo profile created on server."),await m()}}catch(s){g(s?.message||"Unexpected error while creating profile")}finally{M(!1)}},X=async()=>{if(f?.id&&confirm("Delete this demo profile row?")){p(null),$(!0);try{const{data:s}=await d.auth.getUser();if(s?.user?.id===f.id){const{error:t}=await d.from("users").delete().eq("id",f.id);t?p(`Failed to delete: ${t.message}`):(p("Profile row deleted."),await m())}else{const t=await fetch(`/api/supabase-auth/demo/profile/${encodeURIComponent(f.id)}`,{method:"DELETE"}),r=await t.json().catch(()=>({}));t.ok?(p("Profile row deleted on server."),await m()):p(r?.error||"Server deletion failed")}}catch(s){p(s?.message||"Unexpected error while deleting profile")}finally{$(!1)}}},V=async()=>{S(null),I(!0);try{const{data:s}=await d.auth.getUser(),t=s?.user?.id||f?.id||"dev-demo-user",r=o.user?.email||s?.user?.email||"demo@oncosaferx.local",a=o.user?.role||"oncologist",h=await fetch("/api/supabase-auth/demo/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,email:r,role:a,first_name:"Demo",last_name:"Clinician",updateAuth:!!s?.user?.id})}),y=await h.json().catch(()=>({}));h.ok?(S("Reset to demo user successful."),await m()):S(y?.error||"Reset failed")}catch(s){S(s?.message||"Unexpected error during reset")}finally{I(!1)}},z=async()=>{w(null),J(!0);try{const{data:s,error:t}=await d.auth.getUser();if(t||!s?.user){w("Supabase session required to sync from auth.");return}const r=s.user,a=r.email||"",l=r.user_metadata?.role||"oncologist",c=r.user_metadata?.first_name||"Demo",h=r.user_metadata?.last_name||"Clinician",{error:y}=await d.from("users").upsert({id:r.id,email:a,role:l,first_name:c,last_name:h,created_at:new Date().toISOString()},{onConflict:"id"});y?w(`Sync failed: ${y.message}`):(w("Synced auth metadata to profile."),await m())}catch(s){w(s?.message||"Unexpected error during sync")}finally{J(!1)}};return e.jsxs("div",{className:"max-w-5xl mx-auto p-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Auth Diagnostics"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"View current session, verify with backend, and confirm profile row. Dev auth is supported."}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsxs("div",{className:"mb-3 text-xs text-gray-600",children:["App auth: ",o.isAuthenticated?"Authenticated":"Not authenticated"," • User: ",o.user?.email||"n/a"," • Role: ",o.user?.role||"n/a",!n&&e.jsx("div",{className:"mt-1 text-yellow-700",children:"No Supabase session detected (using app-level auth). This is normal in development bypass."})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Session"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:m,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded",children:"Refresh"}),n&&e.jsx("button",{onClick:()=>G(n),className:"px-3 py-1.5 text-sm bg-gray-100 border rounded",children:"Copy Token"})]})]}),B?e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"}):n?e.jsxs("div",{className:"text-sm",children:[U&&e.jsxs("div",{className:"mb-2 text-xs text-yellow-700",children:["Session warning: ",U]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Subject (sub)"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:x?.sub||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium text-gray-900",children:x?.email||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Expires"}),e.jsxs("div",{className:"font-medium text-gray-900",children:[T?.toISOString()||"—"," ",F!==null&&`(in ${F}s)`]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Issuer"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:x?.iss||"—"})]})]})]}):e.jsx("div",{className:"text-sm text-red-700",children:"No active session"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Backend Verification"}),u?e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"mb-1",children:["Status: ",e.jsx("span",{className:u.ok?"text-green-700":"text-red-700",children:u.ok?"OK":"Failed"})," (",u.status,")"]}),u.body&&e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(u.body,null,2)}),u.error&&e.jsx("div",{className:"text-red-700",children:u.error})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Waiting…"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Profile Row (public.users)"}),E&&e.jsx("div",{className:"mb-2 text-sm text-yellow-700",children:E}),f?e.jsxs(e.Fragment,{children:[e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(f,null,2)}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:z,disabled:k,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",children:k?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:V,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:X,disabled:O,className:"px-3 py-1.5 text-sm bg-red-600 text-white rounded disabled:opacity-50",children:O?"Deleting…":"Delete Demo Profile Row"}),(_||v||q)&&e.jsx("div",{className:"text-xs text-gray-600",children:_||v||q})]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-yellow-700 mb-3",children:"No profile row found for current user."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:z,disabled:k||!n,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",title:n?"":"Requires Supabase session",children:k?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:V,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:Q,disabled:L,className:"px-3 py-1.5 text-sm bg-green-600 text-white rounded disabled:opacity-50",children:L?"Creating…":"Create Demo Profile Row"}),(_||v||A)&&e.jsx("div",{className:"text-xs text-gray-600",children:_||v||A})]}),!n&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Tip: No Supabase session detected. The server demo endpoint will be used to insert a profile row (dev-only)."})]})]})]})]})};export{se as default};
//# sourceMappingURL=AuthDiagnostics-Cgnt9KlB.js.map
