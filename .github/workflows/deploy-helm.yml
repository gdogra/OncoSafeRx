name: Deploy via Helm

on:
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Image tag to deploy'
        required: true
  push:
    branches: [ main ]
    paths:
      - 'k8s/helm/**'

jobs:
  helm-upgrade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.4'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${KUBE_CONFIG}" | base64 -d > $HOME/.kube/config
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG_B64 }}

      - name: Helm upgrade/install
        env:
          IMAGE_REPO: ghcr.io/${{ github.repository }}
          IMAGE_TAG: ${{ inputs.image-tag || github.sha }}
        run: |
          helm upgrade --install oncosaferx k8s/helm/oncosaferx \
            --set image.repository=${IMAGE_REPO} \
            --set image.tag=${IMAGE_TAG} \
            --set secrets.JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --set secrets.SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --set secrets.SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --set secrets.SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

