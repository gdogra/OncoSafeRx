import{p as L,r as o,x as F,j as e,S as I,O as M,C as $,X as q,z as O}from"./index-4Ly-s4cr.js";import{C as z}from"./Card-DLOVFYwQ.js";import{R as G}from"./refresh-cw-Da3gWcAr.js";import{S as J}from"./square-pen-CnczSAg3.js";const T=10,K=()=>{console.log("🚀 ServerPatients component loaded");const{actions:D}=L(),[p,v]=o.useState(""),[d,h]=o.useState(1),[f,b]=o.useState(0),[y,N]=o.useState([]),[j,k]=o.useState(!1),[n,i]=o.useState(null),[S,P]=o.useState(!1),[C,u]=o.useState(null),[Q,w]=o.useState(!1),E=o.useMemo(()=>Math.max(1,Math.ceil(f/T)),[f]),{showToast:A}=F(),m=async t=>{console.log("🎯 fetchPatients called with opts:",t),k(!0),console.log("⚡ setLoading(true) completed");try{console.log("💫 Getting authentication token...");let s=null;try{const a=localStorage.getItem("osrx_auth_tokens");if(console.log("💫 Stored tokens raw:",a?"Found":"Not found"),a){const l=JSON.parse(a);console.log("💫 Parsed token info:",{hasAccessToken:!!l.access_token,expiresAt:l.expires_at,now:Date.now()}),l.access_token&&l.expires_at>Date.now()?(s=l.access_token,console.log("💫 Using stored JWT token")):console.log("💫 Stored token expired or invalid")}}catch(a){console.warn("💫 Failed to get stored token:",a)}if(!s)try{const a=O.auth.getSession(),l=new Promise((W,_)=>setTimeout(()=>_(new Error("Session timeout")),1e3)),{data:R}=await Promise.race([a,l]);s=R?.session?.access_token,console.log("💫 Got token from getSession()")}catch(a){console.warn("💫 getSession() failed:",a.message)}console.log("💫 Final token status:",{hasToken:!!s});const c=t?.resetPage?1:d,x=new URLSearchParams({q:p,page:String(c),pageSize:String(T)});console.log("🔍 Fetching patients:",{url:`/api/patients?${x.toString()}`,hasToken:!!s,page:c,query:p,environment:"production",baseURL:window.location.origin});try{const a=await fetch("/api/health",{signal:AbortSignal.timeout(3e3)});console.log("🏥 API health check:",{status:a.status,ok:a.ok,url:a.url})}catch(a){console.warn("⚠️ API health check failed:",a?.message)}let r=await fetch(`/api/patients?${x.toString()}`,{headers:s?{Authorization:`Bearer ${s}`}:{},signal:AbortSignal.timeout(5e3)});if(console.log("📡 Patients API response:",{status:r.status,ok:r.ok,statusText:r.statusText,hasToken:!!s}),!r.ok&&r.status===401&&console.log("🔄 Authentication required - this is expected in production"),r.ok){const a=await r.json();console.log("✅ Patients API success:",{patientsCount:a.patients?.length||0,total:a.total||0,offline:a.offline,samplePatient:a.patients?.[0]}),N(a.patients||[]),b(a.total||0),w(a.offline||!1),t?.resetPage&&h(1)}else{console.error("❌ Patients API failed:",{status:r.status,statusText:r.statusText,headers:Object.fromEntries(r.headers.entries()),url:r.url});const a=await r.text();console.error("❌ Error response body:",a),N([]),b(0),w(!1),r.status===401?console.error("❌ Authentication failed - user may need to log in again"):r.status===503&&console.error("❌ Database service unavailable"),t?.resetPage&&h(1)}}catch(s){console.error("❌ Error fetching patients:",s),console.error("❌ Error details:",{name:s?.name,message:s?.message,stack:s?.stack}),N([]),b(0),w(!1)}finally{k(!1)}};o.useEffect(()=>{console.log("📅 useEffect triggered (page:",d,"), calling fetchPatients"),m()},[d]);const g=t=>{const s=t.data||t;D.setCurrentPatient({...s,id:t.id||s.id})},B=t=>{const s=t.data?.demographics||t.demographics||{};i({id:t.id,firstName:s.firstName||"",lastName:s.lastName||"",mrn:s.mrn||"",dateOfBirth:s.dateOfBirth||"",sex:s.sex||"unknown",original:t}),u(null)},U=async()=>{if(n){if(!n.firstName?.trim()||!n.lastName?.trim()){u("First and last name are required");return}P(!0),u(null);try{const{data:t}=await O.auth.getSession(),s=t?.session?.access_token;s||console.log("⚠️ No Supabase token, proceeding without authentication (backend will use default user)");const c=n.original?.data||n.original,x={...c||{},id:n.id,demographics:{...c?.demographics||{},firstName:n.firstName,lastName:n.lastName,mrn:n.mrn,dateOfBirth:n.dateOfBirth,sex:n.sex},lastUpdated:new Date().toISOString()},r={"Content-Type":"application/json"};s&&(r.Authorization=`Bearer ${s}`);const a=await fetch("/api/patients",{method:"POST",headers:r,body:JSON.stringify({patient:x})});if(!a.ok){const l=await a.json().catch(()=>({}));throw new Error(l?.error||`Save failed (${a.status})`)}i(null),await m(),A("success","Patient updated")}catch(t){u(t?.message||"Save failed"),A("error",t?.message||"Save failed")}finally{P(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(z,{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(I,{className:"w-5 h-5 text-gray-400"}),e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"All Patients"})]}),y.length===0&&!j&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"No Patients Found:"})," You haven't created any patients yet."]}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:'Use the "Create Patient" button in the patient selector to add your first patient.'})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("input",{value:p,onChange:t=>v(t.target.value),placeholder:"Search by name or MRN",className:"flex-1 border border-gray-300 rounded px-3 py-2 text-sm"}),e.jsx("button",{onClick:()=>m({resetPage:!0}),className:"px-3 py-2 bg-blue-600 text-white rounded text-sm",children:"Search"}),e.jsx("button",{onClick:()=>{v(""),m({resetPage:!0})},className:"px-3 py-2 bg-white border rounded text-sm",children:"Clear"}),e.jsxs("button",{onClick:()=>m(),className:"px-3 py-2 bg-white border rounded text-sm flex items-center gap-1",children:[e.jsx(G,{className:"w-4 h-4"})," Refresh"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"MRN"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"DOB"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Last Updated"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[y.map(t=>{const s=t.data?.demographics||t.demographics||{},c=`${s.firstName||""} ${s.lastName||""}`.trim(),x=s.mrn||"",r=s.dateOfBirth?new Date(s.dateOfBirth).toLocaleDateString():"",a=t.data?.lastUpdated||t.lastUpdated?new Date(t.data?.lastUpdated||t.lastUpdated).toLocaleString():"";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 cursor-pointer",onClick:()=>g(t),children:c||"—"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>g(t),children:x||"—"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>g(t),children:r||"—"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>g(t),children:a||"—"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600",children:e.jsxs("button",{onClick:()=>B(t),className:"inline-flex items-center px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",children:[e.jsx(J,{className:"w-4 h-4 mr-1"})," Edit"]})})]},t.id)}),y.length===0&&!j&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-6 text-center text-sm text-gray-500",children:"No patients found"})}),j&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-6 text-center text-sm text-gray-500",children:"Loading…"})})]})]})}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",d," of ",E," • ",f," total"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:d<=1,onClick:()=>h(t=>Math.max(1,t-1)),className:"px-2 py-1 bg-white border rounded disabled:opacity-50",children:e.jsx(M,{className:"w-4 h-4"})}),e.jsx("button",{disabled:d>=E,onClick:()=>h(t=>t+1),className:"px-2 py-1 bg-white border rounded disabled:opacity-50",children:e.jsx($,{className:"w-4 h-4"})})]})]})]}),n&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Edit Patient"}),e.jsx("button",{onClick:()=>i(null),className:"text-gray-400 hover:text-gray-600","aria-label":"Close",children:e.jsx(q,{className:"w-5 h-5"})})]}),C&&e.jsx("div",{className:"mb-3 text-sm text-red-700",children:C}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{value:n.firstName,onChange:t=>i({...n,firstName:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{value:n.lastName,onChange:t=>i({...n,lastName:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"MRN"}),e.jsx("input",{value:n.mrn,onChange:t=>i({...n,mrn:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Date of Birth"}),e.jsx("input",{type:"date",value:n.dateOfBirth,onChange:t=>i({...n,dateOfBirth:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Sex"}),e.jsxs("select",{value:n.sex,onChange:t=>i({...n,sex:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"female",children:"Female"}),e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"other",children:"Other"}),e.jsx("option",{value:"unknown",children:"Unknown"})]})]})]}),e.jsxs("div",{className:"mt-5 flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>i(null),className:"px-3 py-1.5 text-sm bg-white border rounded",children:"Cancel"}),e.jsx("button",{onClick:U,disabled:S,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:S?"Saving…":"Save"})]})]})})]})};export{K as default};
//# sourceMappingURL=ServerPatients-CgkK-bXW.js.map
