import React, { useState, useEffect } from 'react';\nimport { useAuth } from '../../context/AuthContext';\nimport aiRecommendationEngine from '../../services/aiRecommendationEngine';\n\ninterface DecisionNode {\n  id: string;\n  type: 'question' | 'recommendation' | 'action' | 'alert';\n  title: string;\n  content: string;\n  options?: DecisionOption[];\n  severity?: 'low' | 'medium' | 'high' | 'critical';\n  evidenceLevel?: 'A' | 'B' | 'C' | 'D';\n  sources?: string[];\n  nextNode?: string;\n  actions?: {\n    primary?: string;\n    secondary?: string;\n    emergency?: string;\n  };\n}\n\ninterface DecisionOption {\n  id: string;\n  text: string;\n  value: any;\n  nextNode: string;\n  risk?: 'low' | 'medium' | 'high';\n}\n\ninterface ClinicalDecisionTreeProps {\n  scenario: string;\n  patientContext?: any;\n  medications?: string[];\n  onDecisionComplete?: (result: any) => void;\n}\n\nconst ClinicalDecisionTree: React.FC<ClinicalDecisionTreeProps> = ({\n  scenario,\n  patientContext = {},\n  medications = [],\n  onDecisionComplete\n}) => {\n  const { user } = useAuth();\n  const [currentNode, setCurrentNode] = useState<string>('start');\n  const [history, setHistory] = useState<Array<{ nodeId: string; answer: any; timestamp: Date }>>([]);\n  const [answers, setAnswers] = useState<Record<string, any>>({});\n  const [recommendations, setRecommendations] = useState<any[]>([]);\n  const [loading, setLoading] = useState(false);\n\n  // Decision tree configurations for different scenarios\n  const decisionTrees: Record<string, DecisionNode[]> = {\n    drug_interaction: [\n      {\n        id: 'start',\n        type: 'question',\n        title: 'Drug Interaction Assessment',\n        content: 'Let\\'s assess potential drug interactions step by step.',\n        options: [\n          {\n            id: 'proceed',\n            text: 'Begin Assessment',\n            value: 'start',\n            nextNode: 'patient_age'\n          }\n        ]\n      },\n      {\n        id: 'patient_age',\n        type: 'question',\n        title: 'Patient Age',\n        content: 'What is the patient\\'s age group?',\n        options: [\n          { id: 'young', text: '18-64 years', value: 'adult', nextNode: 'organ_function' },\n          { id: 'elderly', text: '65-74 years', value: 'elderly', nextNode: 'organ_function', risk: 'medium' },\n          { id: 'very_elderly', text: '75+ years', value: 'very_elderly', nextNode: 'organ_function', risk: 'high' }\n        ]\n      },\n      {\n        id: 'organ_function',\n        type: 'question',\n        title: 'Organ Function',\n        content: 'Assess kidney and liver function:',\n        options: [\n          { id: 'normal', text: 'Normal function', value: 'normal', nextNode: 'interaction_check' },\n          { id: 'mild_impair', text: 'Mild impairment', value: 'mild', nextNode: 'interaction_check', risk: 'medium' },\n          { id: 'severe_impair', text: 'Severe impairment', value: 'severe', nextNode: 'high_risk_warning', risk: 'high' }\n        ]\n      },\n      {\n        id: 'high_risk_warning',\n        type: 'alert',\n        title: '‚ö†Ô∏è High Risk Patient',\n        content: 'Patient has risk factors that increase interaction severity. Enhanced monitoring required.',\n        severity: 'high',\n        nextNode: 'interaction_check'\n      },\n      {\n        id: 'interaction_check',\n        type: 'action',\n        title: 'Interaction Analysis',\n        content: 'Analyzing drug combinations...',\n        nextNode: 'recommendations'\n      },\n      {\n        id: 'recommendations',\n        type: 'recommendation',\n        title: 'Clinical Recommendations',\n        content: 'Based on the assessment, here are the recommendations:',\n        actions: {\n          primary: 'Review medication list',\n          secondary: 'Monitor patient closely',\n          emergency: 'Contact prescriber immediately'\n        }\n      }\n    ],\n    \n    pain_management: [\n      {\n        id: 'start',\n        type: 'question',\n        title: 'Pain Management Assessment',\n        content: 'Comprehensive pain and opioid risk assessment.',\n        options: [\n          {\n            id: 'proceed',\n            text: 'Start Assessment',\n            value: 'start',\n            nextNode: 'pain_severity'\n          }\n        ]\n      },\n      {\n        id: 'pain_severity',\n        type: 'question',\n        title: 'Pain Severity',\n        content: 'Rate current pain level (0-10 scale):',\n        options: [\n          { id: 'mild', text: '1-3 (Mild)', value: 'mild', nextNode: 'non_opioid_first' },\n          { id: 'moderate', text: '4-6 (Moderate)', value: 'moderate', nextNode: 'opioid_history' },\n          { id: 'severe', text: '7-10 (Severe)', value: 'severe', nextNode: 'opioid_history', risk: 'high' }\n        ]\n      },\n      {\n        id: 'non_opioid_first',\n        type: 'recommendation',\n        title: 'Non-Opioid Treatment',\n        content: 'For mild pain, consider non-opioid alternatives first.',\n        evidenceLevel: 'A',\n        sources: ['CDC Guidelines', 'WHO Pain Ladder'],\n        nextNode: 'monitoring_plan'\n      },\n      {\n        id: 'opioid_history',\n        type: 'question',\n        title: 'Opioid History',\n        content: 'Does patient have history of substance use disorder?',\n        options: [\n          { id: 'no_history', text: 'No history', value: 'no', nextNode: 'respiratory_risk' },\n          { id: 'past_history', text: 'Past history (>1 year)', value: 'past', nextNode: 'high_risk_opioid', risk: 'medium' },\n          { id: 'recent_history', text: 'Recent history (<1 year)', value: 'recent', nextNode: 'avoid_opioids', risk: 'high' }\n        ]\n      },\n      {\n        id: 'avoid_opioids',\n        type: 'alert',\n        title: 'üö´ Avoid Opioids',\n        content: 'High risk for opioid use disorder. Consider alternative pain management strategies.',\n        severity: 'critical',\n        nextNode: 'alternative_strategies'\n      },\n      {\n        id: 'respiratory_risk',\n        type: 'question',\n        title: 'Respiratory Risk Factors',\n        content: 'Check for respiratory complications:',\n        options: [\n          { id: 'no_resp_risk', text: 'No respiratory issues', value: 'none', nextNode: 'dose_calculation' },\n          { id: 'mild_resp', text: 'Mild COPD/asthma', value: 'mild', nextNode: 'reduced_dose', risk: 'medium' },\n          { id: 'severe_resp', text: 'Severe respiratory disease', value: 'severe', nextNode: 'avoid_opioids', risk: 'high' }\n        ]\n      }\n    ],\n    \n    oncology_regimen: [\n      {\n        id: 'start',\n        type: 'question',\n        title: 'Oncology Regimen Selection',\n        content: 'Evidence-based chemotherapy regimen decision support.',\n        options: [\n          {\n            id: 'proceed',\n            text: 'Begin Assessment',\n            value: 'start',\n            nextNode: 'cancer_type'\n          }\n        ]\n      },\n      {\n        id: 'cancer_type',\n        type: 'question',\n        title: 'Cancer Type',\n        content: 'Select primary cancer type:',\n        options: [\n          { id: 'lung', text: 'Lung Cancer', value: 'lung', nextNode: 'lung_subtype' },\n          { id: 'breast', text: 'Breast Cancer', value: 'breast', nextNode: 'breast_subtype' },\n          { id: 'colorectal', text: 'Colorectal Cancer', value: 'colorectal', nextNode: 'performance_status' },\n          { id: 'other', text: 'Other', value: 'other', nextNode: 'performance_status' }\n        ]\n      },\n      {\n        id: 'performance_status',\n        type: 'question',\n        title: 'Performance Status',\n        content: 'Patient\\'s ECOG performance status:',\n        options: [\n          { id: 'ecog0', text: 'ECOG 0 (Fully active)', value: 0, nextNode: 'biomarker_status' },\n          { id: 'ecog1', text: 'ECOG 1 (Restricted activity)', value: 1, nextNode: 'biomarker_status' },\n          { id: 'ecog2', text: 'ECOG 2 (Ambulatory >50%)', value: 2, nextNode: 'modified_regimen', risk: 'medium' },\n          { id: 'ecog3', text: 'ECOG 3+ (Limited activity)', value: 3, nextNode: 'palliative_only', risk: 'high' }\n        ]\n      }\n    ]\n  };\n\n  const getCurrentDecisionTree = () => {\n    return decisionTrees[scenario] || decisionTrees.drug_interaction;\n  };\n\n  const getCurrentNode = (): DecisionNode | null => {\n    const tree = getCurrentDecisionTree();\n    return tree.find(node => node.id === currentNode) || null;\n  };\n\n  const handleOptionSelect = async (option: DecisionOption) => {\n    const timestamp = new Date();\n    \n    // Record the answer\n    setAnswers(prev => ({\n      ...prev,\n      [currentNode]: option.value\n    }));\n    \n    // Add to history\n    setHistory(prev => [...prev, {\n      nodeId: currentNode,\n      answer: option.value,\n      timestamp\n    }]);\n    \n    // Handle special actions\n    if (option.nextNode === 'interaction_check') {\n      await performInteractionAnalysis();\n    }\n    \n    // Navigate to next node\n    setCurrentNode(option.nextNode);\n  };\n\n  const performInteractionAnalysis = async () => {\n    if (medications.length === 0) return;\n    \n    setLoading(true);\n    try {\n      const analysisContext = {\n        ...patientContext,\n        age: answers.patient_age,\n        organFunction: answers.organ_function,\n        ...answers\n      };\n      \n      const analysis = await aiRecommendationEngine.analyzeInteractions(\n        medications,\n        analysisContext\n      );\n      \n      setRecommendations(analysis.analysis.recommendations);\n      \n    } catch (error) {\n      console.error('Analysis failed:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleGoBack = () => {\n    if (history.length === 0) return;\n    \n    const lastEntry = history[history.length - 1];\n    setCurrentNode(lastEntry.nodeId);\n    \n    // Remove last entry from history\n    setHistory(prev => prev.slice(0, -1));\n    \n    // Remove last answer\n    const newAnswers = { ...answers };\n    delete newAnswers[lastEntry.nodeId];\n    setAnswers(newAnswers);\n  };\n\n  const handleComplete = () => {\n    const result = {\n      scenario,\n      answers,\n      history,\n      recommendations,\n      completedAt: new Date().toISOString(),\n      completedBy: user?.id\n    };\n    \n    onDecisionComplete?.(result);\n  };\n\n  const node = getCurrentNode();\n  \n  if (!node) {\n    return (\n      <div className=\"p-6 text-center\">\n        <div className=\"text-red-500 mb-2\">‚ö†Ô∏è Decision tree not found</div>\n        <div className=\"text-gray-600\">Scenario: {scenario}</div>\n      </div>\n    );\n  }\n\n  const getSeverityColor = (severity?: string) => {\n    switch (severity) {\n      case 'critical': return 'bg-red-500 text-white';\n      case 'high': return 'bg-orange-500 text-white';\n      case 'medium': return 'bg-yellow-500 text-white';\n      case 'low': return 'bg-green-500 text-white';\n      default: return 'bg-blue-500 text-white';\n    }\n  };\n\n  const getEvidenceBadge = (level?: string) => {\n    const colors = {\n      'A': 'bg-green-100 text-green-800',\n      'B': 'bg-yellow-100 text-yellow-800', \n      'C': 'bg-orange-100 text-orange-800',\n      'D': 'bg-red-100 text-red-800'\n    };\n    \n    return level ? (\n      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${colors[level as keyof typeof colors]}`}>\n        Evidence Level {level}\n      </span>\n    ) : null;\n  };\n\n  return (\n    <div className=\"clinical-decision-tree max-w-4xl mx-auto p-6\">\n      {/* Progress indicator */}\n      <div className=\"mb-6\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h2 className=\"text-xl font-semibold text-gray-900\">\n            Clinical Decision Support\n          </h2>\n          <div className=\"text-sm text-gray-500\">\n            Step {history.length + 1}\n          </div>\n        </div>\n        <div className=\"w-full bg-gray-200 rounded-full h-2\">\n          <div \n            className=\"bg-blue-500 h-2 rounded-full transition-all duration-300\"\n            style={{ width: `${(history.length / 8) * 100}%` }}\n          />\n        </div>\n      </div>\n\n      {/* Current node content */}\n      <div className=\"bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden\">\n        {/* Header */}\n        <div className={`px-6 py-4 ${getSeverityColor(node.severity)}`}>\n          <h3 className=\"text-lg font-semibold\">{node.title}</h3>\n          {node.evidenceLevel && (\n            <div className=\"mt-2\">\n              {getEvidenceBadge(node.evidenceLevel)}\n            </div>\n          )}\n        </div>\n\n        {/* Content */}\n        <div className=\"px-6 py-4\">\n          <p className=\"text-gray-700 mb-4\">{node.content}</p>\n          \n          {/* Loading state */}\n          {loading && (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>\n              <span className=\"ml-3 text-gray-600\">Analyzing...</span>\n            </div>\n          )}\n\n          {/* Options for questions */}\n          {node.type === 'question' && node.options && (\n            <div className=\"space-y-3\">\n              {node.options.map((option) => (\n                <button\n                  key={option.id}\n                  onClick={() => handleOptionSelect(option)}\n                  className={`w-full p-4 text-left rounded-lg border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all ${\n                    option.risk === 'high' ? 'border-red-200 hover:border-red-300 hover:bg-red-50' :\n                    option.risk === 'medium' ? 'border-yellow-200 hover:border-yellow-300 hover:bg-yellow-50' : ''\n                  }`}\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium\">{option.text}</span>\n                    {option.risk && (\n                      <span className={`px-2 py-1 text-xs rounded-full ${\n                        option.risk === 'high' ? 'bg-red-100 text-red-800' :\n                        option.risk === 'medium' ? 'bg-yellow-100 text-yellow-800' :\n                        'bg-green-100 text-green-800'\n                      }`}>\n                        {option.risk} risk\n                      </span>\n                    )}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n\n          {/* Recommendations display */}\n          {node.type === 'recommendation' && recommendations.length > 0 && (\n            <div className=\"space-y-4\">\n              {recommendations.map((rec, index) => (\n                <div key={index} className={`p-4 rounded-lg border-l-4 ${\n                  rec.priority === 'urgent' ? 'border-red-500 bg-red-50' :\n                  rec.priority === 'high' ? 'border-orange-500 bg-orange-50' :\n                  'border-blue-500 bg-blue-50'\n                }`}>\n                  <h4 className=\"font-semibold text-gray-900\">{rec.title}</h4>\n                  <p className=\"text-gray-700 mt-1\">{rec.description}</p>\n                  <p className=\"text-gray-600 text-sm mt-2\">\n                    <strong>Action:</strong> {rec.action}\n                  </p>\n                  {rec.monitoring && (\n                    <p className=\"text-gray-600 text-sm mt-1\">\n                      <strong>Monitoring:</strong> {rec.monitoring}\n                    </p>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Action buttons */}\n          {node.actions && (\n            <div className=\"space-y-3 mt-4\">\n              {node.actions.primary && (\n                <button className=\"w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors\">\n                  {node.actions.primary}\n                </button>\n              )}\n              {node.actions.secondary && (\n                <button className=\"w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors\">\n                  {node.actions.secondary}\n                </button>\n              )}\n              {node.actions.emergency && (\n                <button className=\"w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors animate-pulse\">\n                  üö® {node.actions.emergency}\n                </button>\n              )}\n            </div>\n          )}\n\n          {/* Sources */}\n          {node.sources && node.sources.length > 0 && (\n            <div className=\"mt-4 pt-4 border-t border-gray-200\">\n              <h5 className=\"text-sm font-medium text-gray-900 mb-2\">Sources:</h5>\n              <div className=\"flex flex-wrap gap-2\">\n                {node.sources.map((source, index) => (\n                  <span key={index} className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full\">\n                    {source}\n                  </span>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Navigation */}\n      <div className=\"mt-6 flex items-center justify-between\">\n        <button\n          onClick={handleGoBack}\n          disabled={history.length === 0}\n          className=\"flex items-center px-4 py-2 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed\"\n        >\n          <svg className=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n          </svg>\n          Back\n        </button>\n\n        {node.type === 'recommendation' && (\n          <button\n            onClick={handleComplete}\n            className=\"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors\"\n          >\n            Complete Assessment\n          </button>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default ClinicalDecisionTree;"