import{a9 as ae,u as re,r as i,j as e,z as m}from"./index-4Ly-s4cr.js";function ie(n){try{if(!n)return null;const j=n.split(".");if(j.length<2)return null;const o=j[1].replace(/-/g,"+").replace(/_/g,"/"),D=o.padEnd(o.length+(4-o.length%4)%4,"="),g=atob(D);return JSON.parse(g)}catch{return null}}const oe=()=>{const{state:n}=ae(),j=re(),[o,D]=i.useState(null),[g,H]=i.useState(null),[x,E]=i.useState(null),[h,_]=i.useState(null),[Q,w]=i.useState(!0),[U,P]=i.useState(null),[L,X]=i.useState(null),[M,A]=i.useState(!1),[O,p]=i.useState(null),[I,$]=i.useState(!1),[J,y]=i.useState(null),[N,q]=i.useState(!1),[S,k]=i.useState(null),[C,F]=i.useState(!1),[R,v]=i.useState(null),[c,V]=i.useState(null),[W,z]=i.useState(null),Y=async(s,a)=>await Promise.race([s,new Promise((r,t)=>setTimeout(()=>t(new Error("timeout")),a))]),d=async()=>{w(!0);try{const{data:{session:s},error:a}=await m.auth.getSession();a&&X(a.message);const r=s?.access_token||null;D(r),H(ie(r));try{const t={};r&&(t.Authorization=`Bearer ${r}`);const l=await fetch("/api/supabase-auth/verify",{headers:t}),u=await l.json().catch(()=>({}));E({ok:l.ok,status:l.status,body:u})}catch(t){E({ok:!1,status:0,error:t?.message||"Network error"})}if(P(null),s?.user?.id)try{const t=await Y(m.from("users").select("id,email,first_name,last_name,role,created_at").eq("id",s.user.id).maybeSingle(),4e3);t?.error&&P(t.error.message||"Profile query error"),_(t?.data||null)}catch(t){P(t?.message==="timeout"?"Profile query timed out":t?.message||"Network error"),_(null)}else _(null);try{const l=await(await fetch("/api/config/check")).json();V(l),z(null)}catch(t){z(t?.message||"Failed to fetch server config"),V(null)}}finally{w(!1)}};i.useEffect(()=>{let s=!1;const a=setTimeout(()=>{s||w(!1)},2500);return d().catch(()=>w(!1)),()=>{s=!0,clearTimeout(a)}},[]);const Z=async s=>{try{await navigator.clipboard.writeText(s)}catch{}},T=g?.exp?new Date(g.exp*1e3):null,ee=new Date,B=T?Math.max(0,Math.floor((T.getTime()-ee.getTime())/1e3)):null,se=async()=>{p(null),A(!0);try{const{data:s}=await m.auth.getUser(),a=n.user?.email||s?.user?.email||"user@example.com",r=n.user?.role||"oncologist",t=n.user?.firstName||s?.user?.user_metadata?.first_name||a.split("@")[0],l=n.user?.lastName||s?.user?.user_metadata?.last_name||"User";if(s?.user?.id){const{error:u}=await m.from("users").upsert({id:s.user.id,email:a,first_name:t,last_name:l,role:r,created_at:new Date().toISOString()},{onConflict:"id"});if(u){p(`Failed to create profile: ${u.message}`);return}p("Demo profile created/updated successfully."),await d()}else{const u=`dev-${Date.now()}`,f=await fetch("/api/supabase-auth/demo/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u,email:a,role:r,first_name:t,last_name:l})}),b=await f.json().catch(()=>({}));if(!f.ok){p(b?.error||"Server demo profile creation failed");return}p("Demo profile created on server."),await d()}}catch(s){p(s?.message||"Unexpected error while creating profile")}finally{A(!1)}},te=async()=>{if(h?.id&&confirm("Delete this demo profile row?")){y(null),$(!0);try{const{data:s}=await m.auth.getUser();if(s?.user?.id===h.id){const{error:a}=await m.from("users").delete().eq("id",h.id);a?y(`Failed to delete: ${a.message}`):(y("Profile row deleted."),await d())}else{const a=await fetch(`/api/supabase-auth/demo/profile/${encodeURIComponent(h.id)}`,{method:"DELETE"}),r=await a.json().catch(()=>({}));a.ok?(y("Profile row deleted on server."),await d()):y(r?.error||"Server deletion failed")}}catch(s){y(s?.message||"Unexpected error while deleting profile")}finally{$(!1)}}},K=async()=>{k(null),q(!0);try{const{data:s}=await m.auth.getUser(),a=s?.user?.id||h?.id||"dev-demo-user",r=n.user?.email||s?.user?.email||"demo@oncosaferx.local",t=n.user?.role||"oncologist",f=await fetch("/api/supabase-auth/demo/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a,email:r,role:t,first_name:"Demo",last_name:"Clinician",updateAuth:!!s?.user?.id})}),b=await f.json().catch(()=>({}));f.ok?(k("Reset to demo user successful."),await d()):k(b?.error||"Reset failed")}catch(s){k(s?.message||"Unexpected error during reset")}finally{q(!1)}},G=async()=>{v(null),F(!0);try{const{data:s,error:a}=await m.auth.getUser();if(a||!s?.user){v("Supabase session required to sync from auth.");return}const r=s.user,t=r.email||"",l=r.user_metadata?.role||"oncologist",u=r.user_metadata?.first_name||"Demo",f=r.user_metadata?.last_name||"Clinician",{error:b}=await m.from("users").upsert({id:r.id,email:t,role:l,first_name:u,last_name:f,created_at:new Date().toISOString()},{onConflict:"id"});b?v(`Sync failed: ${b.message}`):(v("Synced auth metadata to profile."),await d())}catch(s){v(s?.message||"Unexpected error during sync")}finally{F(!1)}};return e.jsxs("div",{className:"max-w-5xl mx-auto p-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 mb-4",children:"Auth Diagnostics"}),e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"View current session, verify with backend, and confirm profile row. Dev auth is supported."}),e.jsxs("div",{className:"mb-6 flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j(`/auth?next=${encodeURIComponent("/auth-diagnostics")}`),className:"px-3 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Sign in via Supabase"}),e.jsx("button",{onClick:()=>d(),className:"px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200",children:"Refresh Session"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsxs("div",{className:"mb-3 text-xs text-gray-600",children:["App auth: ",n.isAuthenticated?"Authenticated":"Not authenticated"," • User: ",n.user?.email||"n/a"," • Role: ",n.user?.role||"n/a",!o&&e.jsx("div",{className:"mt-1 text-yellow-700",children:"No Supabase session detected (using app-level auth). This is normal in development bypass."})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Session"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:d,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded",children:"Refresh"}),o&&e.jsx("button",{onClick:()=>Z(o),className:"px-3 py-1.5 text-sm bg-gray-100 border rounded",children:"Copy Token"})]})]}),Q?e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"}):o?e.jsxs("div",{className:"text-sm",children:[L&&e.jsxs("div",{className:"mb-2 text-xs text-yellow-700",children:["Session warning: ",L]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Subject (sub)"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:g?.sub||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium text-gray-900",children:g?.email||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Expires"}),e.jsxs("div",{className:"font-medium text-gray-900",children:[T?.toISOString()||"—"," ",B!==null&&`(in ${B}s)`]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500",children:"Issuer"}),e.jsx("div",{className:"font-medium text-gray-900 break-all",children:g?.iss||"—"})]})]})]}):e.jsx("div",{className:"text-sm text-red-700",children:"No active session"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Backend Verification"}),x?e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"mb-1",children:["Status: ",e.jsx("span",{className:x.ok?"text-green-700":"text-red-700",children:x.ok?"OK":"Failed"})," (",x.status,")"]}),x.body&&e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(x.body,null,2)}),x.error&&e.jsx("div",{className:"text-red-700",children:x.error})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Waiting…"})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Profile Row (public.users)"}),U&&e.jsx("div",{className:"mb-2 text-sm text-yellow-700",children:U}),h?e.jsxs(e.Fragment,{children:[e.jsx("pre",{className:"bg-gray-50 border rounded p-2 overflow-auto text-xs",children:JSON.stringify(h,null,2)}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:G,disabled:C,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",children:C?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:K,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:te,disabled:I,className:"px-3 py-1.5 text-sm bg-red-600 text-white rounded disabled:opacity-50",children:I?"Deleting…":"Delete Demo Profile Row"}),(R||S||J)&&e.jsx("div",{className:"text-xs text-gray-600",children:R||S||J})]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-yellow-700 mb-3",children:"No profile row found for current user."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:G,disabled:C||!o,className:"px-3 py-1.5 text-sm bg-gray-100 border rounded disabled:opacity-50",title:o?"":"Requires Supabase session",children:C?"Syncing…":"Sync Auth Metadata to Profile"}),e.jsx("button",{onClick:K,disabled:N,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:N?"Resetting…":"Reset to Demo User"}),e.jsx("button",{onClick:se,disabled:M,className:"px-3 py-1.5 text-sm bg-green-600 text-white rounded disabled:opacity-50",children:M?"Creating…":"Create Demo Profile Row"}),(R||S||O)&&e.jsx("div",{className:"text-xs text-gray-600",children:R||S||O})]}),!o&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Tip: No Supabase session detected. The server demo endpoint will be used to insert a profile row (dev-only)."})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded p-4",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Server Config Check"}),W&&e.jsx("div",{className:"text-sm text-red-700",children:W}),c?e.jsxs("div",{className:"text-sm text-gray-700 grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Supabase"}),e.jsxs("div",{children:["Enabled: ",String(c.supabase?.enabled)]}),e.jsxs("div",{children:["URL present: ",String(c.supabase?.urlPresent)]}),e.jsxs("div",{children:["Service role present: ",String(c.supabase?.serviceRolePresent)]}),e.jsxs("div",{children:["JWT secret present: ",String(c.supabase?.jwtSecretPresent)]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Deploy Integrations"}),e.jsxs("div",{children:["Netlify configured: ",String(c.netlify?.configured)]}),e.jsxs("div",{children:["Render configured: ",String(c.render?.configured)]})]}),c.warnings?.length>0&&e.jsxs("div",{className:"md:col-span-2 text-xs text-yellow-700",children:["Warnings: ",c.warnings.join(", ")]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"})]})]})]})};export{oe as default};
//# sourceMappingURL=AuthDiagnostics-BDKqCEtw.js.map
