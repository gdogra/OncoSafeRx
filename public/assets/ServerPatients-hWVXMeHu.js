import{r as l,j as e}from"./index-8LC8IQKY.js";import{C as Z}from"./Card-D3HCI77k.js";import{a as ee,b as te,s as C}from"./App-oj_FpO4B.js";import{C as se}from"./ComprehensivePatientForm-cBX_6vHm.js";import{C as ae}from"./Coachmark-B1BRBLjM.js";import{S as z}from"./search-Cd1nfMpK.js";import{P}from"./plus-BSkQUrbd.js";import{R as oe}from"./refresh-cw-COcu3qHG.js";import{S as re}from"./square-pen-5H-W882X.js";import{c as ne}from"./createLucideIcon-DlukwGQd.js";import{C as ie}from"./chevron-right-gr4R8e8i.js";import{X as le}from"./x-CQXgGKGO.js";import"./Tooltip-CCp_Mki3.js";import"./info-BEmptaGI.js";import"./circle-alert-DFeyOpEy.js";import"./circle-question-mark-UIDQGT3E.js";import"./user-Dpecevp5.js";import"./phone-BDjQDKh0.js";import"./heart-i3E_mUuI.js";import"./activity-BXSagPiR.js";import"./shield-BY4b8Nc2.js";import"./house-svls-J_z.js";import"./save-CZVRNu7b.js";import"./index-DthtDp8X.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],de=ne("chevron-left",ce),J=10,Be=()=>{console.log("üöÄ ServerPatients component loaded");const{actions:w}=ee(),[E,R]=l.useState(""),[u,N]=l.useState(1),[_,A]=l.useState(0),[p,T]=l.useState([]),[f,L]=l.useState(!1),[n,g]=l.useState(null),[F,$]=l.useState(!1),[D,j]=l.useState(null),[I,O]=l.useState(!1),[k,V]=l.useState(!1),[S,h]=l.useState(!1),[K,M]=l.useState(()=>{try{return localStorage.getItem("osrx_tip_create_patient_seen")!=="true"}catch{return!1}}),[Y,U]=l.useState(!1),G=l.useMemo(()=>Math.max(1,Math.ceil(_/J)),[_]),{showToast:y}=te(),B=!0;l.useEffect(()=>{console.log("üîç ServerPatients DEBUG:",{canCreatePatients:B,showCreateForm:S,patientsCount:p.length,loading:f,usingDemoData:I,usingDefaultUser:k})},[B,S,p.length,f,I,k]);const q=l.useRef(!1);l.useEffect(()=>{const t=a=>{const c=a.target,d=(c?.tagName||"").toLowerCase();d==="input"||d==="textarea"||c?.isContentEditable||(a.key==="c"||a.key==="C")&&(a.preventDefault(),h(!0))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]);const b=async t=>{console.log("üéØ fetchPatients called with opts:",t),L(!0),console.log("‚ö° setLoading(true) completed");try{console.log("üí´ Getting authentication token...");let a=null;try{const s=localStorage.getItem("osrx_auth_tokens");if(console.log("üí´ Stored tokens raw:",s?"Found":"Not found"),s){const r=JSON.parse(s);console.log("üí´ Parsed token info:",{hasAccessToken:!!r.access_token,expiresAt:r.expires_at,now:Date.now()}),r.access_token&&r.expires_at>Date.now()?(a=r.access_token,console.log("üí´ Using stored JWT token")):console.log("üí´ Stored token expired or invalid")}}catch(s){console.warn("üí´ Failed to get stored token:",s)}if(!a)try{const s=C.auth.getSession(),r=new Promise((m,x)=>setTimeout(()=>x(new Error("Session timeout")),1e3)),{data:i}=await Promise.race([s,r]);a=i?.session?.access_token,console.log("üí´ Got token from getSession()")}catch(s){console.warn("üí´ getSession() failed:",s.message)}console.log("üí´ Final token status:",{hasToken:!!a});const c=t?.resetPage?1:u,d=new URLSearchParams({q:E,page:String(c),pageSize:String(J)});console.log("üîç Fetching patients:",{url:`/api/patients?${d.toString()}`,hasToken:!!a,page:c,query:E,environment:"production",baseURL:window.location.origin});try{const s=await fetch("/api/health",{signal:AbortSignal.timeout(3e3)});console.log("üè• API health check:",{status:s.status,ok:s.ok,url:s.url})}catch(s){console.warn("‚ö†Ô∏è API health check failed:",s?.message)}let o=null;try{o=await fetch(`/api/patients?${d.toString()}`,{headers:a?{Authorization:`Bearer ${a}`}:{},signal:AbortSignal.timeout(5e3)})}catch(s){const r=s?.name==="TimeoutError"||/timeout/i.test(String(s?.message||""));if(console.warn("‚è±Ô∏è Primary patients fetch failed, timeout?",r,s?.message),r)try{const i=`/api/patients?${d.toString()}&offline=1`;o=await fetch(i,{signal:AbortSignal.timeout(2e3)}),console.log("üîÅ Offline fallback response status:",o.status)}catch(i){throw console.warn("‚ö†Ô∏è Offline fallback failed:",i?.message),s}else throw s}if(console.log("üì° Patients API response:",{status:o.status,ok:o.ok,statusText:o.statusText,hasToken:!!a}),!o.ok&&o.status===401&&console.log("üîÑ Authentication required - this is expected in production"),o&&o.ok){const s=await o.json();console.log("‚úÖ Patients API success:",{patientsCount:s.patients?.length||0,total:s.total||0,offline:s.offline,samplePatient:s.patients?.[0]}),T(s.patients||[]),A(s.total||0),O(s.offline||!1),V(!!s.defaultUser);try{if(!q.current&&Array.isArray(s.patients)&&s.patients.length){const r=localStorage.getItem("osrx_last_patient_id");if(r){const i=s.patients.find(m=>String(m.id)===String(r));i&&(w.setCurrentPatient(i.data||i),q.current=!0,console.log("üîÅ Restored last-selected patient from storage:",r))}}}catch{}t?.resetPage&&N(1)}else{console.error("‚ùå Patients API failed:",o?{status:o.status,statusText:o.statusText,headers:Object.fromEntries(o.headers.entries()),url:o.url}:{error:"no response"});const s=o?await o.text():"no response";console.error("‚ùå Error response body:",s),T([]),A(0),O(!1),o.status===401?console.error("‚ùå Authentication failed - user may need to log in again"):o.status===503&&console.error("‚ùå Database service unavailable"),t?.resetPage&&N(1)}}catch(a){console.error("‚ùå Error fetching patients:",a),console.error("‚ùå Error details:",{name:a?.name,message:a?.message,stack:a?.stack}),T([]),A(0),O(!1)}finally{L(!1)}},H=async t=>{console.log("üè• === PATIENT CREATION DEBUG START ==="),console.log("üè• Input patientData:",t);try{const a={firstName:t.firstName||"Unknown",lastName:t.lastName||"Patient",dateOfBirth:t.dateOfBirth||"1980-01-01",sex:t.sex||"unknown",mrn:t.mrn||`MRN${Date.now()}`,heightCm:t.heightCm||170,weightKg:t.weightKg||70};console.log("üè• Built demographics:",a);let c="guest";try{const{data:r}=await C.auth.getSession();c=r?.session?.user?.id||c,console.log("üè• CreatedBy from session:",c)}catch(r){console.log("üè• Session error:",r)}const d={id:`patient-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,demographics:a,allergies:t.allergies||[],medications:[],conditions:t.medicalConditions||[],labValues:t.labValues?[t.labValues]:[],genetics:[],vitals:t.vitals?[t.vitals]:[],treatmentHistory:[],notes:[],preferences:{},lastUpdated:new Date().toISOString(),createdBy:c,isActive:!0};console.log("üè• Prepared newPatient object:",d),console.log("üè• Setting patient optimistically..."),w.setCurrentPatient(d),console.log("üè• ‚úÖ Patient set in context");let o=null;try{const{data:r}=await C.auth.getSession();o=r?.session?.access_token||null,console.log("üè• Supabase session token:",o?"Present":"Missing")}catch(r){console.log("üè• Supabase session error:",r)}if(!o)try{const r=localStorage.getItem("osrx_auth_tokens");r&&(o=JSON.parse(r).access_token||null,console.log("üè• LocalStorage token:",o?"Present":"Missing"))}catch(r){console.log("üè• LocalStorage token error:",r)}const s={"Content-Type":"application/json"};o?(s.Authorization=`Bearer ${o}`,console.log("üè• Added Authorization header with token")):console.log("üè• ‚ö†Ô∏è No token available - proceeding without auth"),console.log("üè• Request headers:",Object.keys(s)),console.log("üè• Making API call to /api/patients...");try{const r=JSON.stringify({patient:d});console.log("üè• Request body:",r);const i=await fetch("/api/patients",{method:"POST",headers:s,body:r});if(console.log("üè• API Response status:",i.status),console.log("üè• API Response ok:",i.ok),console.log("üè• API Response headers:",Object.fromEntries(i.headers.entries())),i.ok){const m=await i.json().catch(X=>(console.log("üè• JSON parse error:",X),{}));console.log("üè• API Response body:",m);const x=m?.patient?m.patient.data||m.patient:null;if(console.log("üè• Extracted serverPatient:",x),x){console.log("üè• Updating context with server patient..."),w.setCurrentPatient(x);try{localStorage.setItem("osrx_last_patient_id",String(x.id||""))}catch{}}console.log("üè• ‚úÖ Showing success toast..."),y("success","Patient created successfully"),console.log("üè• Refreshing patient list..."),await b({resetPage:!0}),console.log("üè• ‚úÖ Patient list refreshed")}else{const m=await i.text().catch(()=>"Unknown error");console.log("üè• ‚ùå API Error response:",m),y("error",`Create failed: ${i.status} ${m}`);try{console.log("üè• Attempting sync from server..."),await w.syncFromServer()}catch(x){console.log("üè• Sync error:",x)}}}catch(r){console.log("üè• ‚ùå Network error:",r),y("warning","Saved locally (network error)")}console.log("üè• Closing create form..."),h(!1),console.log("üè• === PATIENT CREATION DEBUG END ===")}catch(a){console.log("üè• ‚ùå Global error in createNewPatient:",a),y("error","Failed to create patient")}};l.useEffect(()=>{console.log("üìÖ useEffect triggered (page:",u,"), calling fetchPatients"),b()},[u]);const v=t=>{const a=t.data||t;w.setCurrentPatient({...a,id:t.id||a.id});try{localStorage.setItem("osrx_last_patient_id",String(t.id||a.id))}catch{}},Q=t=>{const a=t.data?.demographics||t.demographics||{};g({id:t.id,firstName:a.firstName||"",lastName:a.lastName||"",mrn:a.mrn||"",dateOfBirth:a.dateOfBirth||"",sex:a.sex||"unknown",original:t}),j(null)},W=async()=>{if(n){if(!n.firstName?.trim()||!n.lastName?.trim()){j("First and last name are required");return}$(!0),j(null);try{const{data:t}=await C.auth.getSession(),a=t?.session?.access_token;a||console.log("‚ö†Ô∏è No Supabase token, proceeding without authentication (backend will use default user)");const c=n.original?.data||n.original,d={...c||{},id:n.id,demographics:{...c?.demographics||{},firstName:n.firstName,lastName:n.lastName,mrn:n.mrn,dateOfBirth:n.dateOfBirth,sex:n.sex},lastUpdated:new Date().toISOString()},o={"Content-Type":"application/json"};a&&(o.Authorization=`Bearer ${a}`);const s=await fetch("/api/patients",{method:"POST",headers:o,body:JSON.stringify({patient:d})});if(!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r?.error||`Save failed (${s.status})`)}g(null),await b(),y("success","Patient updated")}catch(t){j(t?.message||"Save failed"),y("error",t?.message||"Save failed")}finally{$(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"p-2 bg-yellow-100 border border-yellow-300 rounded text-xs",children:[e.jsx("strong",{children:"DEBUG:"})," canCreatePatients=",String(B),", patients=",p.length,", loading=",String(f)]}),K&&e.jsxs("div",{className:"p-3 rounded-md border bg-green-50 border-green-200 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-green-900",children:'Tip: Use the "Create Patient" button to add your first record.'}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{U(!0)},className:"px-2 py-1 text-xs bg-white border border-green-300 text-green-700 rounded",children:"Guide me"}),e.jsx("button",{onClick:()=>{M(!1);try{localStorage.setItem("osrx_tip_create_patient_seen","true")}catch{}},className:"px-2 py-1 text-xs bg-green-600 text-white rounded",children:"Got it"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5 text-gray-400"}),e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"All Patients"})]}),e.jsxs("button",{id:"create-patient-btn-all",onClick:()=>h(!0),className:"px-3 py-2 bg-green-600 text-white rounded text-sm flex items-center gap-1",children:[e.jsx(P,{className:"w-4 h-4"})," Create Patient"]})]}),e.jsxs(Z,{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(z,{className:"w-5 h-5 text-gray-400"}),e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"All Patients"})]}),p.length===0&&!f&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"No Patients Found:"})," You haven't created any patients yet."]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>h(!0),className:"px-3 py-1.5 bg-green-600 text-white rounded text-xs flex items-center gap-1",children:[e.jsx(P,{className:"w-3.5 h-3.5"})," Create Patient"]}),e.jsxs("span",{className:"text-xs text-blue-700",children:["Tip: press ",e.jsx("kbd",{className:"px-1 py-0.5 border rounded bg-white",children:"C"})," to create"]})]})]}),(k||I)&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-900",children:k?e.jsx(e.Fragment,{children:"Viewing patients for the default user (unauthenticated). Sign in to see your own patients."}):e.jsx(e.Fragment,{children:"Using demo/offline data. Connect to the server to sync your patients."})})}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("input",{value:E,onChange:t=>R(t.target.value),placeholder:"Search by name or MRN",className:"flex-1 border border-gray-300 rounded px-3 py-2 text-sm"}),e.jsx("button",{onClick:()=>b({resetPage:!0}),className:"px-3 py-2 bg-blue-600 text-white rounded text-sm",children:"Search"}),e.jsx("button",{onClick:()=>{R(""),b({resetPage:!0})},className:"px-3 py-2 bg-white border rounded text-sm",children:"Clear"}),e.jsxs("button",{onClick:()=>b(),className:"px-3 py-2 bg-white border rounded text-sm flex items-center gap-1",children:[e.jsx(oe,{className:"w-4 h-4"})," Refresh"]}),e.jsxs("button",{onClick:()=>h(!0),className:"px-3 py-2 bg-green-600 text-white rounded text-sm flex items-center gap-1",children:[e.jsx(P,{className:"w-4 h-4"})," Create Patient"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"MRN"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"DOB"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Last Updated"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[p.map(t=>{const a=t.data?.demographics||t.demographics||{},c=`${a.firstName||""} ${a.lastName||""}`.trim(),d=a.mrn||"",o=a.dateOfBirth?new Date(a.dateOfBirth).toLocaleDateString():"",s=t.data?.lastUpdated||t.lastUpdated?new Date(t.data?.lastUpdated||t.lastUpdated).toLocaleString():"";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 cursor-pointer",onClick:()=>v(t),children:c||"‚Äî"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>v(t),children:d||"‚Äî"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>v(t),children:o||"‚Äî"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 cursor-pointer",onClick:()=>v(t),children:s||"‚Äî"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600",children:e.jsxs("button",{onClick:()=>Q(t),className:"inline-flex items-center px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50",children:[e.jsx(re,{className:"w-4 h-4 mr-1"})," Edit"]})})]},t.id)}),p.length===0&&!f&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-6 text-center text-sm text-gray-500",children:"No patients found"})}),f&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-6 text-center text-sm text-gray-500",children:"Loading‚Ä¶"})})]})]})}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",u," of ",G," ‚Ä¢ ",_," total"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:u<=1,onClick:()=>N(t=>Math.max(1,t-1)),className:"px-2 py-1 bg-white border rounded disabled:opacity-50",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx("button",{disabled:u>=G,onClick:()=>N(t=>t+1),className:"px-2 py-1 bg-white border rounded disabled:opacity-50",children:e.jsx(ie,{className:"w-4 h-4"})})]})]})]}),n&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Edit Patient"}),e.jsx("button",{onClick:()=>g(null),className:"text-gray-400 hover:text-gray-600","aria-label":"Close",children:e.jsx(le,{className:"w-5 h-5"})})]}),D&&e.jsx("div",{className:"mb-3 text-sm text-red-700",children:D}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{value:n.firstName,onChange:t=>g({...n,firstName:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{value:n.lastName,onChange:t=>g({...n,lastName:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"MRN"}),e.jsx("input",{value:n.mrn,onChange:t=>g({...n,mrn:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Date of Birth"}),e.jsx("input",{type:"date",value:n.dateOfBirth,onChange:t=>g({...n,dateOfBirth:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Sex"}),e.jsxs("select",{value:n.sex,onChange:t=>g({...n,sex:t.target.value}),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"female",children:"Female"}),e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"other",children:"Other"}),e.jsx("option",{value:"unknown",children:"Unknown"})]})]})]}),e.jsxs("div",{className:"mt-5 flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>g(null),className:"px-3 py-1.5 text-sm bg-white border rounded",children:"Cancel"}),e.jsx("button",{onClick:W,disabled:F,className:"px-3 py-1.5 text-sm bg-blue-600 text-white rounded disabled:opacity-50",children:F?"Saving‚Ä¶":"Save"})]})]})}),S&&e.jsx(se,{onSubmit:H,onCancel:()=>h(!1)}),!S&&e.jsx("button",{onClick:()=>h(!0),className:"fixed bottom-4 right-4 md:hidden inline-flex items-center justify-center rounded-full shadow-lg bg-green-600 text-white w-12 h-12","aria-label":"Create Patient",title:"Create Patient",children:e.jsx(P,{className:"w-6 h-6"})}),Y&&e.jsx(ae,{anchorId:"create-patient-btn-all",title:"Create a Patient",description:"Click here to add your first patient. You can use the C key as a shortcut.",ctaLabel:"Got it",onCta:()=>{U(!1),M(!1);try{localStorage.setItem("osrx_tip_create_patient_seen","true")}catch{}},onClose:()=>U(!1),tone:"green"})]})};export{Be as default};
